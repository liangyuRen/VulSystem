package com.nju.backend.controller;

import com.nju.backend.config.RespBean;
import com.nju.backend.config.RespBeanEnum;
import com.nju.backend.repository.mapper.VulnerabilityReportMapper;
import com.nju.backend.repository.po.VulnerabilityReport;
import com.nju.backend.service.vulnerability.VulnerabilityDetectionService;
import com.nju.backend.service.vulnerability.VulnerabilityService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/vulnerability")
public class VulnerabilityController {

    @Autowired
    private VulnerabilityService vulnerabilityService;

    @Autowired
    private VulnerabilityDetectionService vulnerabilityDetectionService;

    @Autowired
    private VulnerabilityReportMapper vulnerabilityReportMapper;

    //采纳/不采纳漏洞建议
    @RequestMapping("/accept")
    public RespBean acceptVulnerabilitySuggestion(@RequestParam("vulnerabilityid") int id,@RequestParam("ifaccept") int isAccept) {
        try {
            vulnerabilityService.acceptVulnerabilitySuggestion(id, isAccept);
            return RespBean.success();
        } catch (Exception e) {
            return RespBean.error(RespBeanEnum.ERROR, e.getMessage());
        }
    }

    /**
     * 手动触发漏洞检测（全量检测）
     * 对所有公司的所有语言进行漏洞检测
     */
    @PostMapping("/detect/all")
    public RespBean detectAllVulnerabilities() {
        try {
            System.out.println("=== 手动触发全量漏洞检测 ===");

            // 获取所有漏洞报告
            List<VulnerabilityReport> vulnerabilityReports = vulnerabilityReportMapper.selectList(null);

            if (vulnerabilityReports.isEmpty()) {
                return RespBean.error(RespBeanEnum.ERROR, "没有找到漏洞报告，请先爬取漏洞数据");
            }

            System.out.println("找到 " + vulnerabilityReports.size() + " 个漏洞报告");

            // 执行全量检测
            Map<String, Object> result = vulnerabilityDetectionService.detectVulnerabilitiesForAll(vulnerabilityReports);

            return RespBean.success(result);

        } catch (Exception e) {
            System.err.println("全量漏洞检测失败: " + e.getMessage());
            e.printStackTrace();
            return RespBean.error(RespBeanEnum.ERROR, "漏洞检测失败: " + e.getMessage());
        }
    }

    /**
     * 手动触发漏洞检测（指定公司和语言）
     *
     * @param companyId 公司ID
     * @param language 语言类型（java, python, php, ruby, go, rust, javascript, erlang, c）
     */
    @PostMapping("/detect")
    public RespBean detectVulnerabilities(
            @RequestParam("companyId") int companyId,
            @RequestParam("language") String language) {
        try {
            System.out.println("=== 手动触发漏洞检测 ===");
            System.out.println("公司ID: " + companyId);
            System.out.println("语言: " + language);

            // 获取所有漏洞报告
            List<VulnerabilityReport> vulnerabilityReports = vulnerabilityReportMapper.selectList(null);

            if (vulnerabilityReports.isEmpty()) {
                return RespBean.error(RespBeanEnum.ERROR, "没有找到漏洞报告，请先爬取漏洞数据");
            }

            System.out.println("找到 " + vulnerabilityReports.size() + " 个漏洞报告");

            // 执行检测
            Map<String, Object> result = vulnerabilityDetectionService.detectVulnerabilitiesForCompanyAndLanguage(
                companyId,
                language,
                vulnerabilityReports
            );

            if (result.containsKey("error")) {
                return RespBean.error(RespBeanEnum.ERROR, (String) result.get("error"));
            }

            if (result.containsKey("warning")) {
                return RespBean.success(result);
            }

            return RespBean.success(result);

        } catch (Exception e) {
            System.err.println("漏洞检测失败: " + e.getMessage());
            e.printStackTrace();
            return RespBean.error(RespBeanEnum.ERROR, "漏洞检测失败: " + e.getMessage());
        }
    }

    /**
     * 手动触发漏洞检测（指定项目）
     *
     * @param projectId 项目ID
     */
    @PostMapping("/detect/project")
    public RespBean detectVulnerabilitiesForProject(@RequestParam("projectId") int projectId) {
        try {
            System.out.println("=== 手动触发项目漏洞检测 ===");
            System.out.println("项目ID: " + projectId);

            // TODO: 实现基于项目的漏洞检测
            // 需要根据projectId找到对应的company和language，然后调用检测

            return RespBean.error(RespBeanEnum.ERROR, "项目级别的漏洞检测功能开发中");

        } catch (Exception e) {
            System.err.println("项目漏洞检测失败: " + e.getMessage());
            e.printStackTrace();
            return RespBean.error(RespBeanEnum.ERROR, "漏洞检测失败: " + e.getMessage());
        }
    }

    /**
     * 获取漏洞检测统计信息
     */
    @GetMapping("/stats")
    public RespBean getVulnerabilityStats() {
        try {
            // TODO: 实现漏洞统计功能
            Map<String, Object> stats = new HashMap<>();
            stats.put("message", "统计功能开发中");
            return RespBean.success(stats);
        } catch (Exception e) {
            return RespBean.error(RespBeanEnum.ERROR, e.getMessage());
        }
    }
}
