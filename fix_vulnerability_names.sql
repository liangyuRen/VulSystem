-- ====================================================================
-- 修复数据库中漏洞名称为空的记录
-- 根据 description 字段提取漏洞名称
-- ====================================================================

-- 步骤 1: 修复 AVD 来源的漏洞（从 description 中提取"漏洞名称："后的内容）
UPDATE vulnerability_report
SET vulnerability_name = TRIM(
    SUBSTRING_INDEX(
        SUBSTRING_INDEX(description, '漏洞名称：', -1),
        '）',
        1
    )
)
WHERE (vulnerability_name IS NULL OR vulnerability_name = '')
AND description LIKE '%漏洞名称：%'
AND cve_id LIKE 'AVD-%';

-- 步骤 2: 修复 GitHub 来源的漏洞（从"GitHub Security Advisory:"后提取）
UPDATE vulnerability_report
SET vulnerability_name = TRIM(SUBSTRING(description, 1, LEAST(150, LOCATE('。', CONCAT(description, '。')) - 1)))
WHERE (vulnerability_name IS NULL OR vulnerability_name = '')
AND description LIKE '%GitHub Security Advisory%'
AND cve_id LIKE 'GHSA-%';

-- 步骤 3: 修复 NVD 或其他来源（使用 description 的前 80 个字符）
UPDATE vulnerability_report
SET vulnerability_name = TRIM(SUBSTRING(description, 1, 80))
WHERE (vulnerability_name IS NULL OR vulnerability_name = '')
AND description NOT LIKE '%漏洞名称：%'
AND description NOT LIKE '%GitHub Security Advisory%';

-- ====================================================================
-- 验证修复结果
-- ====================================================================

-- 检查修复前后的统计
SELECT
    '修复后统计' as 统计,
    COUNT(*) as 总数,
    SUM(IF(vulnerability_name IS NULL OR vulnerability_name = '', 1, 0)) as 空名称数,
    ROUND(SUM(IF(vulnerability_name IS NULL OR vulnerability_name = '', 1, 0)) * 100 / COUNT(*), 2) as 空名称比例
FROM vulnerability_report;

-- 查看修复后的示例数据
SELECT
    '修复后示例（AVD）' as 类型,
    id,
    cve_id,
    SUBSTRING(vulnerability_name, 1, 50) as 漏洞名称,
    SUBSTRING(description, 1, 50) as 描述前缀
FROM vulnerability_report
WHERE cve_id LIKE 'AVD-%'
LIMIT 3
UNION ALL
SELECT
    '修复后示例（GitHub）',
    id,
    cve_id,
    SUBSTRING(vulnerability_name, 1, 50),
    SUBSTRING(description, 1, 50)
FROM vulnerability_report
WHERE cve_id LIKE 'GHSA-%'
LIMIT 3;

-- ====================================================================
-- 数据质量检查
-- ====================================================================

-- 检查是否还有为空的名称
SELECT COUNT(*) as 仍为空的漏洞数
FROM vulnerability_report
WHERE vulnerability_name IS NULL OR vulnerability_name = '';

-- 按数据源统计漏洞数量
SELECT
    CASE
        WHEN cve_id LIKE 'AVD-%' THEN 'AVD (阿里云)'
        WHEN cve_id LIKE 'GHSA-%' THEN 'GitHub'
        WHEN cve_id LIKE 'CVE-%' THEN 'NVD/CVE'
        ELSE '其他'
    END as 数据源,
    COUNT(*) as 总数,
    SUM(IF(vulnerability_name IS NULL OR vulnerability_name = '', 1, 0)) as 空名称数
FROM vulnerability_report
GROUP BY 数据源;

-- ====================================================================
-- 修复完成后的清理（可选）
-- ====================================================================

-- 如果需要，删除长度过长的漏洞名称（>255 字符）
-- UPDATE vulnerability_report
-- SET vulnerability_name = SUBSTRING(vulnerability_name, 1, 255)
-- WHERE LENGTH(vulnerability_name) > 255;
