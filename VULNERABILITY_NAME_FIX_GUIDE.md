# æ¼æ´åç§°å’Œæè¿°æ•°æ®ä¸¢å¤±é—®é¢˜ - è¯Šæ–­ä¸ä¿®å¤æ–¹æ¡ˆ

## ğŸ“Š é—®é¢˜è¯Šæ–­ç»“æœ

### åŸºæœ¬æƒ…å†µ
- **æ•°æ®åº“æ€»æ¡æ•°**: 9,114
- **åç§°ä¸ºç©ºçš„è®°å½•**: 1,504 æ¡ (16.5%)
- **æè¿°ä¸ºç©ºçš„è®°å½•**: 0 æ¡ (0%)

### æ ¹æœ¬åŸå› 
âœ… **å·²ç¡®è®¤ï¼šè¿™ä¸æ˜¯ä»£ç  BUGï¼Œè€Œæ˜¯æ•°æ®æºé—®é¢˜**

Flask ç«¯çš„ **AVD æ¼æ´åº“** æ•°æ®æºæ²¡æœ‰æä¾›ç‹¬ç«‹çš„ `vulnerabilityName` å­—æ®µï¼Œå¯¼è‡´ Java åç«¯æ”¶åˆ°çš„æ˜¯ NULLã€‚

### å…·ä½“è¡¨ç°

**ç¤ºä¾‹ 1 - AVD æ¥æºçš„æ¼æ´**:
```
id: 2645
cve_id: AVD-2025-1817596
vulnerability_name: [ç©º]  âŒ
description: "é˜¿é‡Œäº‘æ¼æ´åº“æ”¶å½•çš„æœªå®šä¹‰ç±»å‹æ¼æ´ï¼Œæ¼æ´åç§°ï¼šFlowise get-upload-file ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´"
riskLevel: Medium
```

**é—®é¢˜**ï¼šæ¼æ´åç§°å®é™…ä¸Šåœ¨ `description` å­—æ®µä¸­ï¼Œæ ¼å¼ä¸ºï¼š
```
"é˜¿é‡Œäº‘æ¼æ´åº“æ”¶å½•çš„...,æ¼æ´åç§°ï¼š[å®é™…åç§°]"
```

**ç¤ºä¾‹ 2 - GitHub/NVD æ¥æºçš„æ¼æ´**:
```
id: 11758
cve_id: GHSA-fv2r-r8mp-pg48
vulnerability_name: "Soft Serve does not sanitize ANSI escape sequences in user input"  âœ…
description: "GitHub Security Advisory: Soft Serve does not sanitize..."
riskLevel: Medium
```

---

## ğŸ” æ•°æ®æºåˆ†æ

### æ•°æ®æ¥æºåˆ†å¸ƒ

```sql
SELECT
    CASE
        WHEN cve_id LIKE 'CVE-%' THEN 'NVD'
        WHEN cve_id LIKE 'GHSA-%' THEN 'GitHub'
        WHEN cve_id LIKE 'AVD-%' THEN 'AVD'
        ELSE 'Other'
    END as source,
    COUNT(*) as total,
    SUM(IF(vulnerability_name IS NULL OR vulnerability_name = '', 1, 0)) as empty_names
FROM vulnerability_report
GROUP BY source;
```

### é¢„æœŸç»“æœ
| æ¥æº | æ€»æ•° | åç§°ä¸ºç©º | æ¯”ä¾‹ |
|------|------|---------|------|
| AVD | ~1500 | 1504 | 100% |
| GitHub | ~4000 | 0 | 0% |
| NVD | ~3600 | 0 | 0% |

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: åç«¯æå–æ¼æ´åç§°ï¼ˆæ¨èï¼‰

åœ¨ Java åç«¯ VulnerabilityJobHandler ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªæ–¹æ³•ä» description ä¸­æå–æ¼æ´åç§°ã€‚

**ä¿®æ”¹ä½ç½®**: `VulnerabilityJobHandler.java` çš„ `detectVulnerabilities` æ–¹æ³•

**å®ç°é€»è¾‘**:

```java
/**
 * ä»æè¿°ä¸­æå–æ¼æ´åç§°
 * å¦‚æœ vulnerabilityName ä¸ºç©ºï¼Œå°è¯•ä» description ä¸­æå–
 */
private void extractVulnerabilityNameIfEmpty(VulnerabilityReport report) {
    // å¦‚æœåç§°å·²å­˜åœ¨ï¼Œä¸å¤„ç†
    if (report.getVulnerabilityName() != null && !report.getVulnerabilityName().trim().isEmpty()) {
        return;
    }

    // å°è¯•ä»æè¿°ä¸­æå–
    String description = report.getDescription();
    if (description == null || description.isEmpty()) {
        report.setVulnerabilityName("Unknown Vulnerability");
        return;
    }

    String extracted = extractNameFromDescription(description);
    report.setVulnerabilityName(extracted);
}

/**
 * ä»æè¿°æ–‡æœ¬ä¸­æå–æ¼æ´åç§°
 * æ”¯æŒå¤šç§æ ¼å¼ï¼š
 * 1. "...æ¼æ´åç§°ï¼š[å†…å®¹]..." - AVD æ ¼å¼
 * 2. "GitHub Security Advisory: [å†…å®¹]" - GitHub æ ¼å¼
 * 3. "NVD: [å†…å®¹]" - NVD æ ¼å¼
 */
private String extractNameFromDescription(String description) {
    // æ ¼å¼ 1: é˜¿é‡Œäº‘ AVD æ ¼å¼
    // ä¾‹: "é˜¿é‡Œäº‘æ¼æ´åº“...æ¼æ´åç§°ï¼šFlowise get-upload-file ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´"
    if (description.contains("æ¼æ´åç§°ï¼š")) {
        int startIndex = description.indexOf("æ¼æ´åç§°ï¼š") + "æ¼æ´åç§°ï¼š".length();
        int endIndex = description.indexOf("ï¼ˆ", startIndex);
        if (endIndex == -1) {
            endIndex = description.indexOf("\n", startIndex);
        }
        if (endIndex == -1) {
            endIndex = Math.min(startIndex + 100, description.length());
        }
        String extracted = description.substring(startIndex, endIndex).trim();
        if (!extracted.isEmpty()) {
            return extracted;
        }
    }

    // æ ¼å¼ 2: GitHub æ ¼å¼
    // ä¾‹: "GitHub Security Advisory: Soft Serve does not sanitize ANSI escape sequences"
    if (description.contains("GitHub Security Advisory:")) {
        int startIndex = description.indexOf("GitHub Security Advisory:") + "GitHub Security Advisory:".length();
        int endIndex = Math.min(startIndex + 150, description.length());
        return description.substring(startIndex, endIndex).trim();
    }

    // æ ¼å¼ 3: CVE-NVD é€šç”¨æ ¼å¼
    // å–æè¿°çš„å‰ 80 ä¸ªå­—ç¬¦
    if (description.length() > 100) {
        // å°è¯•åœ¨å¥å·å¤„æˆªæ–­
        int dotIndex = description.indexOf("ã€‚", 50);
        if (dotIndex > 50 && dotIndex < 150) {
            return description.substring(0, dotIndex).trim();
        }
        // å¦åˆ™å–å‰ 80 ä¸ªå­—ç¬¦
        String prefix = description.substring(0, Math.min(80, description.length()));
        int lastSpace = prefix.lastIndexOf(" ");
        if (lastSpace > 20) {
            return prefix.substring(0, lastSpace);
        }
        return prefix;
    }

    // é»˜è®¤ä½¿ç”¨å®Œæ•´æè¿°
    return description.trim();
}
```

### æ–¹æ¡ˆ 2: åœ¨æ•°æ®åº“ä¸­ä¿®å¤æ—§æ•°æ®

```sql
-- æ›´æ–° AVD æ¥æºçš„æ¼æ´åç§°ï¼ˆä» description ä¸­æå–ï¼‰
UPDATE vulnerability_report
SET vulnerability_name = CONCAT(
    SUBSTRING_INDEX(SUBSTRING_INDEX(description, 'æ¼æ´åç§°ï¼š', -1), 'ï¼ˆ', 1),
    ' ',
    SUBSTRING(description, 1, 20)
)
WHERE (vulnerability_name IS NULL OR vulnerability_name = '')
AND description LIKE '%æ¼æ´åç§°ï¼š%'
AND cve_id LIKE 'AVD-%';
```

### æ–¹æ¡ˆ 3: Flask ç«¯å®Œå…¨ä¿®å¤ï¼ˆæœ€å½»åº•ï¼‰

ä¿®æ”¹ Flask çš„çˆ¬è™«è„šæœ¬ï¼Œåœ¨è¿”å›å‰ç¡®ä¿ `vulnerabilityName` æ€»æ˜¯æœ‰å€¼ã€‚

---

## ğŸ”§ æ¨èä¿®å¤æ­¥éª¤

### Step 1: ä¿®æ”¹ Java åç«¯ä»£ç 

åœ¨ `VulnerabilityJobHandler.java` ä¸­ï¼š

1. åœ¨ `parseJsonData` æ–¹æ³•åé¢æ·»åŠ  `extractVulnerabilityNameIfEmpty` å’Œ `extractNameFromDescription` ä¸¤ä¸ªæ–¹æ³•

2. åœ¨ `detectVulnerabilities` æ–¹æ³•ä¸­çš„æ•°æ®åº“æ’å…¥å‰è°ƒç”¨æå–åç§°çš„é€»è¾‘

```java
// åœ¨ VulnerabilityJobHandler.java çš„ detectVulnerabilities æ–¹æ³•ä¸­
for (VulnerabilityReport vulnerabilityReport : vulnerabilities) {
    // âœ… æ–°å¢ï¼šå¦‚æœåç§°ä¸ºç©ºåˆ™å°è¯•ä»æè¿°ä¸­æå–
    extractVulnerabilityNameIfEmpty(vulnerabilityReport);

    for (Company company : companies) {
        // ... åŸæœ‰é€»è¾‘ ...
    }
}
```

### Step 2: ä¿®å¤ç°æœ‰æ•°æ®åº“æ•°æ®

æ‰§è¡Œ SQL è„šæœ¬ä¿®å¤æ—§æ•°æ®ï¼ˆå¯é€‰ï¼Œç­‰å¾…é‡æ–°çˆ¬å–ä¹Ÿå¯ä»¥ï¼‰

```sql
-- éœ€è¦æ‰§è¡Œä¿®å¤ SQL
```

### Step 3: é‡æ–°çˆ¬å–æ¼æ´

- æ–°çˆ¬å–çš„æ¼æ´æ•°æ®ä¼šæœ‰æ­£ç¡®çš„æ¼æ´åç§°
- æ—§æ•°æ®ä¹Ÿè¢«ä¿®å¤äº†

### Step 4: éªŒè¯

æ£€æŸ¥ä¿®å¤åçš„æ•°æ®ï¼š

```sql
SELECT
    COUNT(*) as total,
    SUM(IF(vulnerability_name IS NULL OR vulnerability_name = '', 1, 0)) as empty_count
FROM vulnerability_report;
-- é¢„æœŸ: empty_count = 0
```

---

## ğŸ“ å®Œæ•´ä¿®å¤ä»£ç 

### æ–‡ä»¶: VulnerabilityJobHandler.java

**æ·»åŠ ä½ç½®**: åœ¨ `parseJsonData` æ–¹æ³•åé¢ï¼ˆå¤§çº¦ç¬¬ 160 è¡Œå·¦å³ï¼‰

```java
/**
 * å¦‚æœæ¼æ´åç§°ä¸ºç©ºï¼Œå°è¯•ä»æè¿°ä¸­æå–
 */
private void extractVulnerabilityNameIfEmpty(VulnerabilityReport report) {
    if (report.getVulnerabilityName() != null && !report.getVulnerabilityName().trim().isEmpty()) {
        return;
    }

    String description = report.getDescription();
    if (description == null || description.isEmpty()) {
        report.setVulnerabilityName("Unknown Vulnerability");
        return;
    }

    String extracted = extractNameFromDescription(description);
    report.setVulnerabilityName(extracted);
}

/**
 * ä»æè¿°ä¸­æå–æ¼æ´åç§°
 */
private String extractNameFromDescription(String description) {
    // AVD æ ¼å¼: "...æ¼æ´åç§°ï¼š[å†…å®¹]..."
    if (description.contains("æ¼æ´åç§°ï¼š")) {
        int startIdx = description.indexOf("æ¼æ´åç§°ï¼š") + "æ¼æ´åç§°ï¼š".length();
        int endIdx = description.indexOf("ï¼ˆ", startIdx);
        if (endIdx == -1) endIdx = Math.min(startIdx + 100, description.length());

        String name = description.substring(startIdx, endIdx).trim();
        if (!name.isEmpty()) return name;
    }

    // GitHub æ ¼å¼: "GitHub Security Advisory: [å†…å®¹]"
    if (description.contains("GitHub Security Advisory:")) {
        int startIdx = description.indexOf("GitHub Security Advisory:") + "GitHub Security Advisory:".length();
        return description.substring(startIdx, Math.min(startIdx + 150, description.length())).trim();
    }

    // é€šç”¨æ ¼å¼: å–å‰ 80 å­—ç¬¦æˆ–ç¬¬ä¸€ä¸ªå¥å·å¤„
    if (description.length() > 100) {
        int dotIdx = description.indexOf("ã€‚", 50);
        if (dotIdx > 50 && dotIdx < 150) {
            return description.substring(0, dotIdx).trim();
        }
    }

    return description.substring(0, Math.min(80, description.length())).trim();
}
```

**ä¿®æ”¹ä½ç½®**: åœ¨ `detectVulnerabilities` æ–¹æ³•ä¸­ï¼ˆå¤§çº¦ç¬¬ 180 è¡Œå·¦å³ï¼‰

```java
private void detectVulnerabilities(List<VulnerabilityReport> vulnerabilities) {
    List<Company> companies = companyMapper.selectList(null);
    for (VulnerabilityReport vulnerabilityReport : vulnerabilities) {
        // âœ… æ–°å¢ï¼šç¡®ä¿æ¼æ´åç§°ä¸ä¸ºç©º
        extractVulnerabilityNameIfEmpty(vulnerabilityReport);

        for (Company company : companies) {
            // ... åŸæœ‰é€»è¾‘ç»§ç»­ ...
        }
    }
}
```

---

## ğŸ”„ æ•°æ®ä¿®å¤ SQL

å¦‚æœéœ€è¦ç«‹å³ä¿®å¤æ•°æ®åº“ä¸­çš„æ—§æ•°æ®ï¼š

```sql
-- 1. ä¿®å¤ AVD æ¥æºçš„æ¼æ´ï¼ˆä»æè¿°ä¸­æå–åç§°ï¼‰
UPDATE vulnerability_report
SET vulnerability_name = TRIM(SUBSTRING_INDEX(
    SUBSTRING_INDEX(SUBSTRING_INDEX(description, 'æ¼æ´åç§°ï¼š', -1), 'ï¼‰', 1),
    'ï¼ˆ', 1
))
WHERE (vulnerability_name IS NULL OR vulnerability_name = '')
AND description LIKE '%æ¼æ´åç§°ï¼š%'
AND cve_id LIKE 'AVD-%';

-- 2. ä¿®å¤å…¶ä»–æ¥æºçš„æ¼æ´ï¼ˆä½¿ç”¨æè¿°å‰ 80 å­—ç¬¦ï¼‰
UPDATE vulnerability_report
SET vulnerability_name = SUBSTRING(description, 1, LEAST(80, LOCATE('ã€‚', description) - 1))
WHERE (vulnerability_name IS NULL OR vulnerability_name = '')
AND description NOT LIKE '%æ¼æ´åç§°ï¼š%';

-- 3. éªŒè¯ä¿®å¤ç»“æœ
SELECT
    COUNT(*) as total,
    SUM(IF(vulnerability_name IS NULL OR vulnerability_name = '', 1, 0)) as still_empty
FROM vulnerability_report;
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
```
æ€»æ¼æ´æ•°: 9,114
åç§°ä¸ºç©º: 1,504 (16.5%)
åç§°å®Œæ•´: 7,610 (83.5%)
```

### ä¿®å¤å
```
æ€»æ¼æ´æ•°: 9,114
åç§°ä¸ºç©º: 0 (0%)
åç§°å®Œæ•´: 9,114 (100%) âœ…
```

---

## ğŸ¯ æ€»ç»“

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **é—®é¢˜æ ¹æº** | âœ… å·²è¯Šæ–­ | Flask æ•°æ®æºä¸æä¾› vulnerabilityName |
| **æ•°æ®åº“è®¾è®¡** | âœ… æ­£ç¡® | è¡¨ç»“æ„å’Œå­—æ®µå®šä¹‰éƒ½æ˜¯å¯¹çš„ |
| **Java æ˜ å°„** | âœ… æ­£ç¡® | @JsonProperty æ˜ å°„æ­£ç¡® |
| **ä¿®å¤æ–¹æ¡ˆ** | âœ… å·²å‡†å¤‡ | åç«¯è‡ªåŠ¨æå–åç§° |
| **æ—§æ•°æ®ä¿®å¤** | ğŸ“ å¾…æ‰§è¡Œ | å¯é€‰æ‰§è¡Œ SQL æˆ–ç­‰å¾…é‡æ–°çˆ¬å– |

---

## å»ºè®®

1. **ç«‹å³è¡ŒåŠ¨**ï¼šåœ¨ Java åç«¯æ·»åŠ è‡ªåŠ¨æå–é€»è¾‘ï¼ˆ5 åˆ†é’Ÿä¿®æ”¹ï¼‰
2. **é‡æ–°çˆ¬å–**ï¼šçˆ¬å–æ–°æ¼æ´æ—¶ï¼Œæ–°æ•°æ®ä¼šè‡ªåŠ¨æœ‰æ­£ç¡®çš„åç§°
3. **æ•°æ®æ¸…ç†**ï¼šå¯é€‰æ‰§è¡Œ SQL ä¿®å¤æ—§æ•°æ®ï¼Œæˆ–ä¿æŒç°çŠ¶

è¿™æ ·åšçš„ä¼˜ç‚¹ï¼š
- âœ… å®Œå…¨å‘åå…¼å®¹
- âœ… è‡ªåŠ¨å¤„ç†å„ç§æ ¼å¼
- âœ… ä¸éœ€è¦ä¿®æ”¹ Flask ç«¯
- âœ… é‡æ–°çˆ¬å–æ—¶è‡ªåŠ¨ä¿®å¤

