# ğŸ‰ ç»„ä»¶-æ¼æ´åŒ¹é…ç³»ç»Ÿ - å¤šè¯­è¨€æ”¯æŒå®ç°å®Œæˆ

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. æ‰©å±•æ”¯æŒçš„è¯­è¨€åˆ—è¡¨

**æ–‡ä»¶**: `VulnerabilityJobHandler.java` ç¬¬ 53-55 è¡Œ

```java
// ä¿®æ”¹å‰ï¼š
static List<String> SupportedLanguages = Arrays.asList("java", "c");

// ä¿®æ”¹åï¼š
static List<String> SupportedLanguages = Arrays.asList(
    "java", "c", "python", "php", "ruby", "go", "rust", "javascript", "erlang"
);
```

**æ•ˆæœ**: ç°åœ¨æ”¯æŒå…¨éƒ¨ 9 ç§ç¼–ç¨‹è¯­è¨€çš„æ¼æ´åŒ¹é…

---

### 2. æ·»åŠ å¿…è¦çš„ä¾èµ–æ³¨å…¥

**æ–‡ä»¶**: `VulnerabilityJobHandler.java` ç¬¬ 47-51 è¡Œ

```java
@Autowired
private WhiteListMapper whiteListMapper;

@Autowired
private ProjectMapper projectMapper;
```

**æ•ˆæœ**: å¯ä»¥æŸ¥è¯¢ `white_list` è¡¨å’Œ `project` è¡¨

---

### 3. æ·»åŠ  QueryWrapper å¯¼å…¥

**æ–‡ä»¶**: `VulnerabilityJobHandler.java` ç¬¬ 3 è¡Œ

```java
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
```

---

### 4. æ–°å¢æ•°æ®åº“æŸ¥è¯¢æ–¹æ³•

**æ–‡ä»¶**: `VulnerabilityJobHandler.java` ç¬¬ 279-374 è¡Œ

**æ–¹æ³•**: `getWhiteListFromDatabase(int companyId, String language)`

**åŠŸèƒ½**:
- ä» `white_list` è¡¨è¯»å–å…¬å¸é¡¹ç›®çš„**å®é™…ä¾èµ–**
- æ›¿ä»£ä¹‹å‰ä» `company.whiteList` (JSONå­—æ®µ) è¯»å–çš„é€»è¾‘
- æ”¯æŒæ‰€æœ‰è¯­è¨€çš„ä¾èµ–æŸ¥è¯¢

**é€»è¾‘æµç¨‹**:
```
1. æ ¹æ® companyId æŸ¥è¯¢ company è¡¨
   â†“
2. è§£æ company.projectId (JSONå­—æ®µ) è·å–é¡¹ç›®IDåˆ—è¡¨
   â†“
3. æŸ¥è¯¢è¿™äº›é¡¹ç›®çš„è¯¦ç»†ä¿¡æ¯ï¼Œè·å– file_path
   â†“
4. æŸ¥è¯¢ white_list è¡¨ä¸­è¿™äº› file_path çš„ä¾èµ–ï¼ˆæŒ‡å®šè¯­è¨€ï¼‰
   â†“
5. æ„å»º JSON æ ¼å¼è¿”å›ï¼ˆåŒ¹é… Flask API æœŸæœ›æ ¼å¼ï¼‰
```

**ç¤ºä¾‹è¾“å‡º**:
```json
[
  {"name": "lxml", "language": "python", "pojectid": "32"},
  {"name": "requests", "language": "python", "pojectid": "32"},
  {"name": "Pillow", "language": "python", "pojectid": "32"}
]
```

---

### 5. ä¿®æ”¹æ¼æ´æ£€æµ‹é€»è¾‘

**æ–‡ä»¶**: `VulnerabilityJobHandler.java` ç¬¬ 389-402 è¡Œ

**ä¿®æ”¹å‰**:
```java
String currentWhiteListAsString = null;
try {
    JsonNode whiteListJsonArray = objectMapper.readTree(company.getWhiteList());
    // ä» company.whiteList JSON å­—æ®µè¯»å–ï¼ˆæ‰‹åŠ¨é…ç½®çš„å…³æ³¨åˆ—è¡¨ï¼‰
    ...
}
```

**ä¿®æ”¹å**:
```java
// ===== å…³é”®ä¿®æ”¹ï¼šä» white_list è¡¨è¯»å–æ•°æ® =====
String currentWhiteListAsString = getWhiteListFromDatabase(
    company.getId(),
    language
);

if (currentWhiteListAsString == null ||
    currentWhiteListAsString.equals("[]") ||
    currentWhiteListAsString.equals("")) {
    XxlJobHelper.log("è·³è¿‡ï¼šå…¬å¸ " + company.getName() +
        " æ²¡æœ‰ " + language + " è¯­è¨€çš„ä¾èµ–");
    continue;
}
// ===== ä¿®æ”¹ç»“æŸ =====
```

**æ•ˆæœ**:
- ä½¿ç”¨é¡¹ç›®**å®é™…è§£æå‡ºçš„ä¾èµ–**å‚ä¸æ¼æ´åŒ¹é…
- ä¹‹å‰è§£æçš„ 103 æ¡ä¾èµ–ï¼ˆJava 46, Python 12, PHP 4, Ruby 41ï¼‰ç°åœ¨å¯ä»¥å‚ä¸åŒ¹é…
- æ”¯æŒæ‰€æœ‰ç¼–ç¨‹è¯­è¨€

---

## ğŸ”„ ç³»ç»Ÿå·¥ä½œæµç¨‹

### å®Œæ•´æµç¨‹

```
1. ç”¨æˆ·ä¸Šä¼ é¡¹ç›® (uploadProject)
   â†“
2. è‡ªåŠ¨è§£æé¡¹ç›®ä¾èµ– (asyncParseXXXProject)
   â†“
3. ä¾èµ–å†™å…¥ white_list è¡¨
   â†“
4. XXL-JOB å®šæ—¶ä»»åŠ¡è§¦å‘æ¼æ´æ£€æµ‹
   â†“
5. fetchGithubVulnerabilityData / fetchAvdVulnerabilityData
   â†“
6. detectVulnerabilities (éå†æ‰€æœ‰å…¬å¸å’Œè¯­è¨€)
   â†“
7. getWhiteListFromDatabase è¯»å–å®é™…ä¾èµ–
   â†“
8. è°ƒç”¨ Flask /vulnerabilities/detect API (TF-IDF åŒ¹é…)
   â†“
9. Flask è¿”å›åŒ¹é…çš„ç»„ä»¶åç§°
   â†“
10. å†™å…¥ vulnerability è¡¨
11. å»ºç«‹ vulnerability_report_vulnerability å…³è”
12. å»ºç«‹ project_vulnerability å…³è”
   â†“
13. å®ŒæˆåŒ¹é…
```

---

## ğŸ“Š æ•°æ®åº“è¡¨å…³ç³»

### æ ¸å¿ƒè¡¨

1. **white_list** - é¡¹ç›®å®é™…ä¾èµ–
   - `id`: è‡ªå¢ä¸»é”®
   - `name`: ä¾èµ–åç§°
   - `language`: ç¼–ç¨‹è¯­è¨€
   - `file_path`: é¡¹ç›®è·¯å¾„ï¼ˆå…³è” project è¡¨ï¼‰
   - `description`: ä¾èµ–æè¿°
   - `isdelete`: è½¯åˆ é™¤æ ‡è®°

2. **company** - å…¬å¸ä¿¡æ¯
   - `id`: å…¬å¸ID
   - `name`: å…¬å¸åç§°
   - `projectId`: é¡¹ç›®IDåˆ—è¡¨ (JSONæ ¼å¼ï¼š`{"1": "java", "32": "python"}`)
   - `whiteList`: æ‰‹åŠ¨é…ç½®çš„å…³æ³¨åˆ—è¡¨ (å·²å¼ƒç”¨ï¼Œç°åœ¨ä½¿ç”¨ white_list è¡¨)
   - `detectStrategy`: æ£€æµ‹ç­–ç•¥
   - `similarityThreshold`: ç›¸ä¼¼åº¦é˜ˆå€¼

3. **project** - é¡¹ç›®ä¿¡æ¯
   - `id`: é¡¹ç›®ID
   - `name`: é¡¹ç›®åç§°
   - `file`: é¡¹ç›®è·¯å¾„ï¼ˆå…³è” white_list è¡¨çš„ file_pathï¼‰
   - `language`: ç¼–ç¨‹è¯­è¨€

4. **vulnerability** - æ£€æµ‹åˆ°çš„æ¼æ´
   - `id`: æ¼æ´ID
   - `name`: æ¼æ´åç§°
   - `ref`: CVE ID
   - `language`: å½±å“çš„è¯­è¨€
   - `risk_level`: é£é™©ç­‰çº§
   - `description`: æ¼æ´æè¿°

5. **project_vulnerability** - é¡¹ç›®-æ¼æ´å…³è”
   - `project_id`: é¡¹ç›®ID
   - `vulnerability_id`: æ¼æ´ID

---

## ğŸ§ª æµ‹è¯•æŒ‡å—

### å‰ç½®æ¡ä»¶

1. **æ•°æ®åº“çŠ¶æ€æ£€æŸ¥**:

```sql
-- æŸ¥çœ‹ white_list è¡¨ä¸­çš„ä¾èµ–ç»Ÿè®¡
SELECT language, COUNT(*) as count
FROM white_list
WHERE isdelete = 0
GROUP BY language;
```

**é¢„æœŸç»“æœ**:
```
+----------+-------+
| language | count |
+----------+-------+
| java     |    46 |
| python   |    12 |
| php      |     4 |
| ruby     |    41 |
+----------+-------+
```

2. **æ£€æŸ¥å…¬å¸-é¡¹ç›®å…³è”**:

```sql
-- æŸ¥çœ‹å…¬å¸çš„é¡¹ç›®å…³è”
SELECT id, name, projectId FROM company WHERE id = 1;
```

**é¢„æœŸç»“æœ**:
```
id: 1
name: test
projectId: {"1": "java", "13": "java", ..., "32": "python", "33": "ruby"}
```

---

### æµ‹è¯•æ­¥éª¤ 1ï¼šæ‰‹åŠ¨è§¦å‘ GitHub æ¼æ´æ£€æµ‹

```bash
# åœ¨ XXL-JOB ç®¡ç†ç•Œé¢ï¼ˆæˆ–ç›´æ¥è°ƒç”¨ï¼‰è§¦å‘ä»»åŠ¡
# è®¿é—®: http://localhost:8080/xxl-job-admin
# æ‰‹åŠ¨æ‰§è¡Œ: githubVulnerabilityFetchJob
```

æˆ–è€…å¦‚æœæœ‰ API æ¥å£ï¼š
```bash
curl -X POST http://localhost:8081/api/trigger/githubVulnerabilityFetchJob
```

---

### æµ‹è¯•æ­¥éª¤ 2ï¼šæ£€æŸ¥æ—¥å¿—è¾“å‡º

**æœŸæœ›çš„æ—¥å¿—ç¤ºä¾‹**:

```
========================================
æ£€æµ‹æ¼æ´: CVE-2024-XXXX
å…¬å¸: test
è¯­è¨€: python
----------------------------------------
âœ“ å…¬å¸ test çš„ python ä¾èµ–æ•°é‡: 12
â†’ è°ƒç”¨ Flask API: http://localhost:5000/vulnerabilities/detect
â†’ Flask è¿”å›åŒ¹é…ç»„ä»¶: lxml;requests;Pillow
----------------------------------------
âœ“ æ’å…¥æ¼æ´è®°å½•: lxml ç›¸å…³æ¼æ´
âœ“ æ’å…¥æ¼æ´è®°å½•: requests ç›¸å…³æ¼æ´
âœ“ æ’å…¥æ¼æ´è®°å½•: Pillow ç›¸å…³æ¼æ´
========================================

========================================
æ£€æµ‹æ¼æ´: CVE-2024-YYYY
å…¬å¸: test
è¯­è¨€: php
----------------------------------------
âœ“ å…¬å¸ test çš„ php ä¾èµ–æ•°é‡: 4
â†’ è°ƒç”¨ Flask API: http://localhost:5000/vulnerabilities/detect
â†’ Flask è¿”å›åŒ¹é…ç»„ä»¶: nikic/php-parser
----------------------------------------
âœ“ æ’å…¥æ¼æ´è®°å½•: nikic/php-parser ç›¸å…³æ¼æ´
========================================
```

---

### æµ‹è¯•æ­¥éª¤ 3ï¼šéªŒè¯æ•°æ®åº“å†™å…¥

```sql
-- 1. æŸ¥çœ‹æ£€æµ‹åˆ°çš„æ¼æ´ç»Ÿè®¡
SELECT language, COUNT(*) as count
FROM vulnerability
WHERE is_delete = 0
GROUP BY language;

-- 2. æŸ¥çœ‹æœ€æ–°æ£€æµ‹åˆ°çš„æ¼æ´
SELECT id, name, ref, language, risk_level
FROM vulnerability
WHERE is_delete = 0
ORDER BY id DESC
LIMIT 20;

-- 3. æŸ¥çœ‹é¡¹ç›®-æ¼æ´å…³è”
SELECT
    pv.id,
    p.name as project_name,
    v.name as vulnerability_name,
    v.ref as cve_id,
    v.language,
    v.risk_level
FROM project_vulnerability pv
JOIN project p ON pv.project_id = p.id
JOIN vulnerability v ON pv.vulnerability_id = v.id
WHERE pv.isdelete = 0
ORDER BY pv.id DESC
LIMIT 20;

-- 4. æŸ¥çœ‹ç‰¹å®šé¡¹ç›®çš„æ¼æ´
SELECT
    v.name as vulnerability_name,
    v.ref as cve_id,
    v.risk_level,
    v.language
FROM project_vulnerability pv
JOIN vulnerability v ON pv.vulnerability_id = v.id
WHERE pv.project_id = 32  -- Python é¡¹ç›®
  AND pv.isdelete = 0;
```

---

### æµ‹è¯•æ­¥éª¤ 4ï¼šæµ‹è¯• AVD æ¼æ´æ£€æµ‹

```bash
# åœ¨ XXL-JOB ç®¡ç†ç•Œé¢è§¦å‘: avdVulnerabilityFetchJob
```

æ£€æŸ¥æ—¥å¿—ï¼š
```
âœ“ AVD æ¼æ´æ•°æ®è·å–æˆåŠŸ
âœ“ è§£æ XX æ¡æ¼æ´
âœ“ å¼€å§‹æ£€æµ‹...
```

---

## ğŸ”§ è°ƒè¯•æŒ‡å—

### é—®é¢˜ 1ï¼šæ²¡æœ‰ä¾èµ–è¢«åŒ¹é…

**æ’æŸ¥æ­¥éª¤**:

1. æ£€æŸ¥ white_list è¡¨æ˜¯å¦æœ‰æ•°æ®
```sql
SELECT * FROM white_list WHERE isdelete = 0 LIMIT 10;
```

2. æ£€æŸ¥å…¬å¸çš„ projectId å­—æ®µ
```sql
SELECT projectId FROM company WHERE id = 1;
```

3. æ£€æŸ¥é¡¹ç›®è·¯å¾„æ˜¯å¦æ­£ç¡®
```sql
SELECT id, file FROM project WHERE id IN (32, 33);
```

4. éªŒè¯ white_list çš„ file_path ä¸ project çš„ file æ˜¯å¦ä¸€è‡´
```sql
SELECT DISTINCT wl.file_path, p.file
FROM white_list wl
LEFT JOIN project p ON wl.file_path = p.file
WHERE wl.isdelete = 0
LIMIT 10;
```

---

### é—®é¢˜ 2ï¼šFlask API è¶…æ—¶æˆ–è¿”å›é”™è¯¯

**æ£€æŸ¥ Flask æœåŠ¡**:
```bash
# æµ‹è¯• Flask API
curl "http://localhost:5000/vulnerabilities/detect" \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "cve_id": "CVE-2024-TEST",
    "desc": "Test vulnerability description",
    "white_list": "[{\"name\":\"lxml\",\"language\":\"python\",\"pojectid\":\"32\"}]",
    "company": "test",
    "detect_strategy": "tfidf",
    "similarityThreshold": "0.5",
    "language": "python"
  }'
```

---

### é—®é¢˜ 3ï¼šæ—¥å¿—æ˜¾ç¤º"å…¬å¸æ²¡æœ‰XXè¯­è¨€çš„ä¾èµ–"

**åŸå› **: getWhiteListFromDatabase æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„ä¾èµ–

**æ’æŸ¥**:
```sql
-- æ£€æŸ¥ white_list è¡¨ä¸­æ˜¯å¦æœ‰è¯¥è¯­è¨€çš„ä¾èµ–
SELECT COUNT(*) FROM white_list
WHERE language = 'python' AND isdelete = 0;

-- æ£€æŸ¥é¡¹ç›®è·¯å¾„
SELECT DISTINCT file_path FROM white_list WHERE language = 'python';

-- æ£€æŸ¥é¡¹ç›®è¡¨ä¸­çš„è·¯å¾„
SELECT id, file FROM project WHERE id = 32;
```

---

## ğŸ“ é…ç½®è¯´æ˜

### Company è¡¨é…ç½®é¡¹

**æ£€æµ‹ç­–ç•¥** (`detect_strategy`):
- `tfidf`: TF-IDF ç›¸ä¼¼åº¦åŒ¹é…ï¼ˆæ¨èï¼‰
- `keyword`: å…³é”®è¯åŒ¹é…
- `bert`: BERT è¯­ä¹‰åŒ¹é…ï¼ˆéœ€è¦Flaskæ”¯æŒï¼‰

**ç›¸ä¼¼åº¦é˜ˆå€¼** (`similarity_threshold`):
- èŒƒå›´: 0.0 - 1.0
- æ¨èå€¼: 0.5
- å€¼è¶Šé«˜ï¼ŒåŒ¹é…è¶Šä¸¥æ ¼

**æœ€å¤§æ£€æµ‹æ•°é‡** (`max_detect_num`):
- æ¯ä¸ªæ¼æ´æœ€å¤šåŒ¹é…çš„ç»„ä»¶æ•°é‡
- æ¨èå€¼: 10

---

## ğŸ¯ é¢„æœŸç»“æœ

### æˆåŠŸè¿è¡Œåçš„æ•°æ®åº“çŠ¶æ€

```
vulnerability è¡¨:
  javaæ¼æ´     :  XX æ¡
  pythonæ¼æ´   :  XX æ¡
  phpæ¼æ´      :  XX æ¡
  rubyæ¼æ´     :  XX æ¡
  cæ¼æ´        :  XX æ¡
  æ€»è®¡         :  XX æ¡

project_vulnerability è¡¨:
  é¡¹ç›®ID 32 (Python)  :  XX ä¸ªæ¼æ´
  é¡¹ç›®ID 33 (Ruby)    :  XX ä¸ªæ¼æ´
  é¡¹ç›®ID 30 (PHP)     :  XX ä¸ªæ¼æ´
  é¡¹ç›®ID 26 (Java)    :  XX ä¸ªæ¼æ´
```

---

## âœ… éªŒæ”¶æ¸…å•

- [x] SupportedLanguages æ‰©å±•åˆ° 9 ç§è¯­è¨€
- [x] æ·»åŠ  WhiteListMapper å’Œ ProjectMapper ä¾èµ–æ³¨å…¥
- [x] å®ç° getWhiteListFromDatabase æ–¹æ³•
- [x] ä¿®æ”¹ detectVulnerabilities ä½¿ç”¨ white_list è¡¨æ•°æ®
- [x] ä»£ç ç¼–è¯‘é€šè¿‡
- [ ] XXL-JOB ä»»åŠ¡æˆåŠŸæ‰§è¡Œ
- [ ] vulnerability è¡¨æœ‰æ–°æ•°æ®
- [ ] project_vulnerability è¡¨æœ‰å…³è”è®°å½•
- [ ] å¤šè¯­è¨€ä¾èµ–éƒ½èƒ½å‚ä¸åŒ¹é…

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **å¯åŠ¨ Spring Boot æœåŠ¡**:
```bash
cd backend
JAVA_HOME="C:/Users/ä»»è‰¯ç‰/.jdks/corretto-1.8.0_462" \
PATH="C:/Users/ä»»è‰¯ç‰/.jdks/corretto-1.8.0_462/bin:$PATH" \
mvn spring-boot:run
```

2. **æ‰‹åŠ¨è§¦å‘æ¼æ´æ£€æµ‹ä»»åŠ¡**ï¼ˆåœ¨ XXL-JOB ç®¡ç†ç•Œé¢ï¼‰

3. **æŸ¥çœ‹æ—¥å¿—å’Œæ•°æ®åº“éªŒè¯ç»“æœ**

4. **æ ¹æ®éœ€è¦è°ƒæ•´é…ç½®**ï¼ˆç›¸ä¼¼åº¦é˜ˆå€¼ã€æ£€æµ‹ç­–ç•¥ç­‰ï¼‰

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- `VULNERABILITY_MATCHING_ANALYSIS.md` - é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆ
- `FINAL_COMPLETE_REPORT.md` - å¤šè¯­è¨€ä¾èµ–è§£æå®ŒæˆæŠ¥å‘Š
- `PROBLEM_COMPLETELY_SOLVED.md` - ç»„ä»¶è§£æé—®é¢˜è§£å†³æŠ¥å‘Š

---

**ğŸ‰ å¤šè¯­è¨€ç»„ä»¶-æ¼æ´åŒ¹é…ç³»ç»Ÿ - å®ç°å®Œæˆï¼** âœ…

**æ ¸å¿ƒæ”¹è¿›**:
- âœ… æ”¯æŒ 9 ç§ç¼–ç¨‹è¯­è¨€
- âœ… ä½¿ç”¨å®é™…è§£æçš„ä¾èµ–ï¼ˆwhite_list è¡¨ï¼‰
- âœ… 103 æ¡ä¾èµ–å¯å‚ä¸æ¼æ´åŒ¹é…
- âœ… åŸºäº TF-IDF çš„æ™ºèƒ½åŒ¹é…

**ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹æ¼æ´æ£€æµ‹ï¼** ğŸš€
