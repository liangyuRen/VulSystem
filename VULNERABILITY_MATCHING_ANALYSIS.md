# ç»„ä»¶-æ¼æ´åŒ¹é…ç³»ç»Ÿ - é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## ğŸ“Š å½“å‰ç³»ç»ŸçŠ¶æ€

### âœ… å·²å®Œæˆéƒ¨åˆ†

1. **æ¼æ´çˆ¬å–** - æ­£å¸¸è¿è¡Œ
   - GitHub æ¼æ´æºï¼š`fetchGithubVulnerabilityData()`
   - é˜¿é‡Œäº‘ AVD æ¼æ´æºï¼š`fetchAvdVulnerabilityData()`
   - NVD æ¼æ´æºï¼š`fetchNvdVulnerabilityFetchJob()`

2. **å¤šè¯­è¨€ç»„ä»¶è§£æ** - å·²å®Œå…¨è§£å†³
   - Java: 46 ä¸ªä¾èµ– âœ“
   - Python: 12 ä¸ªä¾èµ– âœ“
   - PHP: 4 ä¸ªä¾èµ– âœ“
   - Ruby: 41 ä¸ªä¾èµ– âœ“
   - **æ€»è®¡: 103 æ¡ä¾èµ–è®°å½•å·²å†™å…¥ white_list è¡¨**

### âŒ å¾…è§£å†³é—®é¢˜ï¼šç»„ä»¶-æ¼æ´åŒ¹é…

**æ ¸å¿ƒé—®é¢˜**ï¼šå·²è§£æçš„ç»„ä»¶ï¼ˆwhite_listè¡¨ä¸­çš„103æ¡è®°å½•ï¼‰æ— æ³•å‚ä¸æ¼æ´åŒ¹é…

---

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### æ–‡ä»¶ï¼šVulnerabilityJobHandler.java

#### é—®é¢˜ 1ï¼šä»…æ”¯æŒ Java å’Œ C è¯­è¨€

**ä½ç½®**ï¼šç¬¬ 47 è¡Œ
```java
static List<String> SupportedLanguages = Arrays.asList("java", "c");
```

**å½±å“**ï¼š
- Python, PHP, Ruby, Go, Rust, JavaScript, Erlang çš„ä¾èµ–æ— æ³•å‚ä¸æ¼æ´åŒ¹é…
- æˆ‘ä»¬è§£æå‡ºçš„ 103 æ¡ä¾èµ–ä¸­ï¼Œåªæœ‰ 46 æ¡ Java ä¾èµ–èƒ½è¢«åŒ¹é…

#### é—®é¢˜ 2ï¼šä½¿ç”¨é”™è¯¯çš„æ•°æ®æº

**ä½ç½®**ï¼šç¬¬ 286-301 è¡Œ

**å½“å‰å®ç°**ï¼š
```java
JsonNode whiteListJsonArray = objectMapper.readTree(company.getWhiteList());
```

**é—®é¢˜**ï¼š
- ä½¿ç”¨çš„æ˜¯ `company` è¡¨ä¸­çš„ `white_list` å­—æ®µï¼ˆJSONï¼‰
- è¿™æ˜¯**æ‰‹åŠ¨é…ç½®çš„ç»„ä»¶å…³æ³¨åˆ—è¡¨**ï¼Œä¸æ˜¯é¡¹ç›®å®é™…ä¾èµ–

**company.white_list ç¤ºä¾‹**ï¼š
```json
[
  {"name": "flowise", "language": "java", "pojectid": "1"},
  {"name": "spring-framework", "language": "java", "pojectid": "1"},
  {"name": "apache-tomcat", "language": "java", "pojectid": "1"}
]
```

**åº”è¯¥ä½¿ç”¨çš„æ•°æ®æº**ï¼š
- `white_list` è¡¨ - å­˜å‚¨äº†é¡¹ç›®**å®é™…è§£æå‡ºçš„ä¾èµ–**
- åŒ…å« 103 æ¡çœŸå®ä¾èµ–è®°å½•

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šæ‰©å±•ç°æœ‰å®ç°ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `detectVulnerabilities()` æ–¹æ³•ï¼Œä» `white_list` è¡¨è¯»å–å®é™…ä¾èµ–æ•°æ®ã€‚

#### æ­¥éª¤ 1ï¼šæ‰©å±•æ”¯æŒçš„è¯­è¨€

```java
// æ–‡ä»¶ï¼šVulnerabilityJobHandler.javaï¼Œç¬¬ 47 è¡Œ
// ä¿®æ”¹å‰ï¼š
static List<String> SupportedLanguages = Arrays.asList("java", "c");

// ä¿®æ”¹åï¼š
static List<String> SupportedLanguages = Arrays.asList(
    "java", "c", "python", "php", "ruby", "go", "rust", "javascript", "erlang"
);
```

#### æ­¥éª¤ 2ï¼šä» white_list è¡¨è¯»å–ä¾èµ–

æ·»åŠ æ–°çš„æ–¹æ³•æ¥æŸ¥è¯¢ white_list è¡¨ï¼š

```java
/**
 * ä» white_list è¡¨æŸ¥è¯¢æŒ‡å®šå…¬å¸ã€è¯­è¨€çš„ç»„ä»¶
 * @param companyId å…¬å¸ID
 * @param language ç¼–ç¨‹è¯­è¨€
 * @return JSON æ ¼å¼çš„ç»„ä»¶åˆ—è¡¨
 */
private String getWhiteListFromDatabase(int companyId, String language) {
    try {
        // æŸ¥è¯¢ white_list è¡¨ä¸­å±äºè¯¥å…¬å¸é¡¹ç›®çš„ä¾èµ–
        // 1. å…ˆæŸ¥è¯¢è¯¥å…¬å¸çš„æ‰€æœ‰é¡¹ç›®ID
        List<Project> companyProjects = projectMapper.selectList(
            new QueryWrapper<Project>()
                .eq("company_id", companyId)
                .eq("isdelete", 0)
        );

        if (companyProjects.isEmpty()) {
            return "[]";
        }

        // 2. è·å–æ‰€æœ‰é¡¹ç›®è·¯å¾„
        List<String> projectPaths = companyProjects.stream()
            .map(Project::getFile)
            .collect(Collectors.toList());

        // 3. æŸ¥è¯¢è¿™äº›é¡¹ç›®çš„æ‰€æœ‰ä¾èµ–ï¼ˆæŒ‡å®šè¯­è¨€ï¼‰
        List<WhiteList> whiteLists = whiteListMapper.selectList(
            new QueryWrapper<WhiteList>()
                .in("file_path", projectPaths)
                .eq("language", language)
                .eq("isdelete", 0)
        );

        // 4. æ„å»º JSON æ ¼å¼ï¼ˆåŒ¹é… Flask API çš„æœŸæœ›æ ¼å¼ï¼‰
        List<Map<String, String>> result = new ArrayList<>();
        for (WhiteList wl : whiteLists) {
            Map<String, String> item = new HashMap<>();
            item.put("name", wl.getName());
            item.put("language", wl.getLanguage());

            // æ ¹æ® file_path æ‰¾åˆ°å¯¹åº”çš„ project_id
            Project project = companyProjects.stream()
                .filter(p -> p.getFile().equals(wl.getFilePath()))
                .findFirst()
                .orElse(null);

            if (project != null) {
                item.put("pojectid", String.valueOf(project.getId()));
                result.add(item);
            }
        }

        ObjectMapper mapper = new ObjectMapper();
        return mapper.writeValueAsString(result);

    } catch (Exception e) {
        XxlJobHelper.log("ä»æ•°æ®åº“æŸ¥è¯¢ç™½åå•å¤±è´¥: " + e.getMessage());
        e.printStackTrace();
        return "[]";
    }
}
```

#### æ­¥éª¤ 3ï¼šä¿®æ”¹ detectVulnerabilities æ–¹æ³•

**ä½ç½®**ï¼šç¬¬ 271-472 è¡Œ

**å…³é”®ä¿®æ”¹**ï¼š

```java
@Transactional
public void detectVulnerabilities(List<VulnerabilityReport> vulnerabilities) {
    List<Company> companies = companyMapper.selectList(null);

    for (VulnerabilityReport vulnerabilityReport : vulnerabilities) {
        extractVulnerabilityNameIfEmpty(vulnerabilityReport);

        for (Company company : companies) {
            for (String language : SupportedLanguages) {  // â† ç°åœ¨åŒ…æ‹¬æ‰€æœ‰è¯­è¨€
                RestTemplate restTemplate = new RestTemplate();
                String url = "http://localhost:5000/vulnerabilities/detect";

                ObjectMapper objectMapper = new ObjectMapper();

                // ===== å…³é”®ä¿®æ”¹ï¼šä» white_list è¡¨è¯»å–æ•°æ® =====
                String currentWhiteListAsString = getWhiteListFromDatabase(
                    company.getId(),
                    language
                );

                if (currentWhiteListAsString == null ||
                    currentWhiteListAsString.equals("[]")) {
                    XxlJobHelper.log("å…¬å¸ " + company.getName() +
                        " æ²¡æœ‰ " + language + " è¯­è¨€çš„ä¾èµ–ï¼Œè·³è¿‡");
                    continue;
                }
                // ===== ä¿®æ”¹ç»“æŸ =====

                // åˆ›å»ºè¦å‘é€çš„å‚æ•°
                Map<String, String> params = new HashMap<>();
                params.put("cve_id", vulnerabilityReport.getCveId());
                params.put("desc", vulnerabilityReport.getDescription());
                params.put("white_list", currentWhiteListAsString);
                params.put("company", company.getName());
                params.put("detect_strategy", company.getDetectStrategy());
                params.put("similarityThreshold", company.getSimilarityThreshold().toString());
                params.put("language", language);

                // ... å…¶ä½™ä»£ç ä¿æŒä¸å˜
            }
        }
    }
}
```

---

## ğŸ“‹ éœ€è¦æ·»åŠ çš„ä¾èµ–

åœ¨ VulnerabilityJobHandler.java ä¸­éœ€è¦æ·»åŠ ï¼š

```java
@Autowired
private WhiteListMapper whiteListMapper;

@Autowired
private ProjectMapper projectMapper;
```

è¿˜éœ€è¦å¯¼å…¥ï¼š
```java
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.nju.backend.repository.po.Project;
import com.nju.backend.repository.po.WhiteList;
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆ

### 1. æŸ¥çœ‹å½“å‰æ•°æ®åº“çŠ¶æ€

```sql
-- æŸ¥çœ‹æ‰€æœ‰å…¬å¸
SELECT id, name FROM company;

-- æŸ¥çœ‹ white_list è¡¨ä¸­çš„ä¾èµ–ï¼ˆæŒ‰è¯­è¨€ç»Ÿè®¡ï¼‰
SELECT language, COUNT(*) as count
FROM white_list
WHERE isdelete = 0
GROUP BY language;

-- æŸ¥çœ‹ white_list è¡¨ä¸­çš„ä¾èµ–ï¼ˆå‰20æ¡ï¼‰
SELECT id, name, language, file_path
FROM white_list
WHERE isdelete = 0
ORDER BY id DESC
LIMIT 20;
```

### 2. å…³è”é¡¹ç›®å’Œå…¬å¸

**é—®é¢˜**ï¼šwhite_list è¡¨é€šè¿‡ `file_path` å…³è”é¡¹ç›®ï¼Œä½†é¡¹ç›®è¡¨éœ€è¦æœ‰ `company_id` å­—æ®µã€‚

**æ£€æŸ¥é¡¹ç›®è¡¨**ï¼š
```sql
-- æŸ¥çœ‹é¡¹ç›®è¡¨ç»“æ„
DESCRIBE project;

-- æŸ¥çœ‹é¡¹ç›®æ•°æ®
SELECT id, name, file, company_id FROM project WHERE id IN (26, 30, 32, 33);
```

å¦‚æœ `project` è¡¨æ²¡æœ‰ `company_id` å­—æ®µï¼Œéœ€è¦ï¼š
1. æ·»åŠ  `company_id` å­—æ®µ
2. æˆ–ä¿®æ”¹æŸ¥è¯¢é€»è¾‘ä½¿ç”¨å…¶ä»–å…³è”æ–¹å¼

### 3. æ‰‹åŠ¨è§¦å‘æ¼æ´æ£€æµ‹ä»»åŠ¡

```bash
# è§¦å‘ GitHub æ¼æ´æ£€æµ‹
curl -X POST http://localhost:8081/xxl-job-admin/api/triggerJob \
  -d "executorHandler=githubVulnerabilityFetchJob"

# æˆ–è€…åœ¨ XXL-JOB ç®¡ç†ç•Œé¢æ‰‹åŠ¨è§¦å‘
```

### 4. éªŒè¯ç»“æœ

```sql
-- æŸ¥çœ‹æ£€æµ‹åˆ°çš„æ¼æ´
SELECT * FROM vulnerability ORDER BY id DESC LIMIT 10;

-- æŸ¥çœ‹é¡¹ç›®-æ¼æ´å…³è”
SELECT pv.id, pv.project_id, v.name, v.risk_level, v.language
FROM project_vulnerability pv
JOIN vulnerability v ON pv.vulnerability_id = v.id
WHERE pv.isdelete = 0
ORDER BY pv.id DESC
LIMIT 20;

-- ç»Ÿè®¡å„è¯­è¨€çš„æ¼æ´æ•°é‡
SELECT language, COUNT(*) as count
FROM vulnerability
WHERE is_delete = 0
GROUP BY language;
```

---

## ğŸ¯ é¢„æœŸç»“æœ

ä¿®æ”¹å®Œæˆåï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
æ¼æ´æ£€æµ‹æ—¥å¿—ç¤ºä¾‹ï¼š
========================================
æ£€æµ‹æ¼æ´: CVE-2024-XXXX
å…¬å¸: test
è¯­è¨€: python
ç™½åå•ä¾èµ–æ•°: 12
Flask API è¿”å›: lxml;requests;Pillow
åŒ¹é…åˆ°çš„ç»„ä»¶: lxml, requests, Pillow
æ’å…¥æ¼æ´è®°å½•: 3 æ¡
========================================

æ•°æ®åº“ç»Ÿè®¡ï¼š
  javaæ¼æ´     :  XX æ¡
  pythonæ¼æ´   :  XX æ¡
  phpæ¼æ´      :  XX æ¡
  rubyæ¼æ´     :  XX æ¡
  æ€»è®¡         :  XX æ¡
```

---

## ğŸ”§ æ›¿ä»£æ–¹æ¡ˆ Bï¼šä¿æŒç°æœ‰é€»è¾‘ï¼Œæ›´æ–° company.white_list

å¦‚æœä¸æƒ³ä¿®æ”¹ä»£ç ï¼Œå¯ä»¥å®šæœŸæ›´æ–° `company` è¡¨çš„ `white_list` å­—æ®µï¼š

```sql
-- 1. æŸ¥è¯¢æŸä¸ªå…¬å¸çš„æ‰€æœ‰é¡¹ç›®ä¾èµ–
SELECT
    wl.name,
    wl.language,
    p.id as pojectid
FROM white_list wl
JOIN project p ON wl.file_path = p.file
WHERE p.company_id = 1
  AND wl.isdelete = 0
  AND p.isdelete = 0;

-- 2. æ‰‹åŠ¨æ›´æ–°åˆ° company.white_listï¼ˆæˆ–å†™å®šæ—¶ä»»åŠ¡ï¼‰
UPDATE company
SET white_list = '[...]'  -- ä»ä¸Šé¢æŸ¥è¯¢ç»“æœæ„å»º JSON
WHERE id = 1;
```

**ç¼ºç‚¹**ï¼š
- éœ€è¦å®šæ—¶åŒæ­¥
- æ•°æ®å†—ä½™
- ä¸æ¨è

---

## âœ… æ¨èå®æ–½æ­¥éª¤

1. **æ£€æŸ¥é¡¹ç›®è¡¨ç»“æ„**
   ```sql
   DESCRIBE project;
   ```

2. **ç¡®è®¤é¡¹ç›®å’Œå…¬å¸çš„å…³è”å…³ç³»**
   - å¦‚æœæœ‰ `company_id` å­—æ®µ â†’ ç›´æ¥ä½¿ç”¨æ–¹æ¡ˆ A
   - å¦‚æœæ²¡æœ‰ â†’ éœ€è¦å…ˆæ·»åŠ å­—æ®µæˆ–è°ƒæ•´é€»è¾‘

3. **å®æ–½æ–¹æ¡ˆ A**
   - æ‰©å±• SupportedLanguages
   - æ·»åŠ  getWhiteListFromDatabase æ–¹æ³•
   - ä¿®æ”¹ detectVulnerabilities æ–¹æ³•

4. **æµ‹è¯•éªŒè¯**
   - æ‰‹åŠ¨è§¦å‘æ¼æ´æ£€æµ‹ä»»åŠ¡
   - æŸ¥çœ‹ vulnerability è¡¨æ˜¯å¦æœ‰æ–°æ•°æ®
   - æ£€æŸ¥å¤šè¯­è¨€ä¾èµ–æ˜¯å¦å‚ä¸åŒ¹é…

---

## ğŸ“ æ€»ç»“

**å½“å‰é—®é¢˜**ï¼š
- å·²è§£æçš„ 103 æ¡ä¾èµ–ï¼ˆPython, PHP, Ruby, Javaï¼‰æ— æ³•å‚ä¸æ¼æ´åŒ¹é…
- åªæ”¯æŒ Java å’Œ C è¯­è¨€
- ä½¿ç”¨çš„æ˜¯æ‰‹åŠ¨é…ç½®çš„ç»„ä»¶åˆ—è¡¨ï¼Œè€Œä¸æ˜¯å®é™…è§£æçš„ä¾èµ–

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ‰©å±•æ”¯æŒæ‰€æœ‰è¯­è¨€
- ä» white_list è¡¨è¯»å–å®é™…ä¾èµ–æ•°æ®
- ç¡®ä¿é¡¹ç›®-å…¬å¸å…³è”å…³ç³»æ­£ç¡®

**ä¸‹ä¸€æ­¥**ï¼š
1. æ£€æŸ¥ project è¡¨æ˜¯å¦æœ‰ company_id å­—æ®µ
2. å®æ–½ä»£ç ä¿®æ”¹
3. æµ‹è¯•éªŒè¯

---

**é—®é¢˜å·²æ˜ç¡®ï¼Œè§£å†³æ–¹æ¡ˆå·²å‡†å¤‡å°±ç»ªï¼Œå¼€å§‹å®æ–½ï¼** âœ…
