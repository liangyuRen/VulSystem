-- ==========================================
-- 修复 vulnerability_report 表的字符集问题
-- ==========================================
-- 问题: 表使用 utf8mb3, 导致中文乱码
-- 解决: 转换为 utf8mb4

USE kulin;

-- 1. 先备份当前数据（可选，但推荐）
CREATE TABLE IF NOT EXISTS vulnerability_report_backup_20251114 AS
SELECT * FROM vulnerability_report;

-- 2. 修改表的默认字符集为 utf8mb4
ALTER TABLE vulnerability_report
CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 3. 显式修改每个文本列的字符集
ALTER TABLE vulnerability_report
MODIFY COLUMN cve_id VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
MODIFY COLUMN description TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
MODIFY COLUMN vulnerability_name VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
MODIFY COLUMN riskLevel VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL,
MODIFY COLUMN referenceLink VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL;

-- 4. 验证修改结果
SHOW CREATE TABLE vulnerability_report\G

-- 5. 查看转换后的数据样例
SELECT id, cve_id, vulnerability_name, riskLevel
FROM vulnerability_report
ORDER BY id DESC
LIMIT 5;
