#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
漏洞检测API测试脚本
测试SpringBoot端的漏洞检测功能
"""

import requests
import json
import time

BACKEND_API = "http://localhost:8081"

def test_detect_all_vulnerabilities():
    """测试全量漏洞检测"""
    print("=" * 60)
    print("测试 1: 全量漏洞检测")
    print("=" * 60)

    url = f"{BACKEND_API}/vulnerability/detect/all"

    print(f"→ 调用 API: {url}")
    print("→ 这可能需要几分钟时间...")

    try:
        response = requests.post(url, timeout=300)

        print(f"\n状态码: {response.status_code}")

        if response.status_code == 200:
            result = response.json()
            print("\n返回结果:")
            print(json.dumps(result, indent=2, ensure_ascii=False))

            if result.get('code') == 200:
                obj = result.get('obj', {})
                print("\n✓ 全量漏洞检测成功!")
                print(f"  总处理漏洞数: {obj.get('totalProcessed', 0)}")
                print(f"  总检测到有漏洞的组件数: {obj.get('totalDetected', 0)}")
                print(f"  公司数量: {obj.get('companiesCount', 0)}")
                print(f"  语言数量: {obj.get('languagesCount', 0)}")
            else:
                print(f"\n✗ 检测失败: {result.get('message', 'Unknown error')}")
        else:
            print(f"\n✗ HTTP错误: {response.status_code}")
            print(f"响应: {response.text[:500]}")

    except requests.exceptions.Timeout:
        print("\n✗ 请求超时")
    except Exception as e:
        print(f"\n✗ 测试失败: {e}")

    print("\n" + "=" * 60)


def test_detect_for_company_and_language(company_id, language):
    """测试指定公司和语言的漏洞检测"""
    print("=" * 60)
    print(f"测试 2: 公司 {company_id} 的 {language} 漏洞检测")
    print("=" * 60)

    url = f"{BACKEND_API}/vulnerability/detect"
    params = {
        'companyId': company_id,
        'language': language
    }

    print(f"→ 调用 API: {url}")
    print(f"→ 参数: companyId={company_id}, language={language}")

    try:
        response = requests.post(url, data=params, timeout=120)

        print(f"\n状态码: {response.status_code}")

        if response.status_code == 200:
            result = response.json()
            print("\n返回结果:")
            print(json.dumps(result, indent=2, ensure_ascii=False))

            if result.get('code') == 200:
                obj = result.get('obj', {})
                print(f"\n✓ 漏洞检测成功!")
                print(f"  公司: {obj.get('company', 'N/A')}")
                print(f"  语言: {obj.get('language', 'N/A')}")
                print(f"  处理漏洞数: {obj.get('processedCount', 0)}")
                print(f"  检测到有漏洞的组件数: {obj.get('detectedCount', 0)}")

                if 'warning' in obj:
                    print(f"  警告: {obj['warning']}")
            else:
                print(f"\n✗ 检测失败: {result.get('message', 'Unknown error')}")
        else:
            print(f"\n✗ HTTP错误: {response.status_code}")
            print(f"响应: {response.text[:500]}")

    except requests.exceptions.Timeout:
        print("\n✗ 请求超时")
    except Exception as e:
        print(f"\n✗ 测试失败: {e}")

    print("\n" + "=" * 60)


def test_check_vulnerability_results():
    """查询数据库中的漏洞检测结果"""
    print("=" * 60)
    print("测试 3: 查询漏洞检测结果")
    print("=" * 60)

    # 这里需要数据库访问，使用Python脚本查询
    try:
        import pymysql

        conn = pymysql.connect(
            host='localhost',
            user='root',
            password='15256785749rly',
            database='kulin',
            charset='utf8mb4'
        )

        cursor = conn.cursor()

        # 查询检测到的漏洞数量（按语言分组）
        cursor.execute("""
            SELECT language, COUNT(*) as count
            FROM vulnerability
            WHERE is_delete = 0
            GROUP BY language
            ORDER BY language
        """)

        print("\n检测到的漏洞（按语言）:")
        print(f"{'语言':<15} {'数量':<10}")
        print("-" * 30)
        total = 0
        for row in cursor.fetchall():
            print(f"{row[0]:<15} {row[1]:<10}")
            total += row[1]
        print("-" * 30)
        print(f"{'总计':<15} {total:<10}")

        # 查询有风险的项目
        cursor.execute("""
            SELECT
                p.id,
                p.name,
                p.language,
                COUNT(*) as vuln_count
            FROM project_vulnerability pv
            JOIN project p ON pv.project_id = p.id
            WHERE pv.isdelete = 0
            GROUP BY p.id, p.name, p.language
            ORDER BY vuln_count DESC
            LIMIT 10
        """)

        print("\n有风险的项目 (Top 10):")
        print(f"{'ID':<5} {'项目名称':<20} {'语言':<10} {'漏洞数':<10}")
        print("-" * 50)
        for row in cursor.fetchall():
            print(f"{row[0]:<5} {row[1]:<20} {row[2]:<10} {row[3]:<10}")

        cursor.close()
        conn.close()

        print("\n✓ 数据库查询成功")

    except Exception as e:
        print(f"\n✗ 数据库查询失败: {e}")
        print("  提示: 请确保pymysql已安装 (pip install pymysql)")

    print("\n" + "=" * 60)


def main():
    print("\n" + "=" * 60)
    print("漏洞检测API测试")
    print("=" * 60)

    # 测试1: 指定公司和语言的检测（快速测试）
    test_detect_for_company_and_language(company_id=1, language='java')

    print("\n等待5秒...")
    time.sleep(5)

    # 测试2: 指定公司和语言的检测（Python）
    test_detect_for_company_and_language(company_id=1, language='python')

    print("\n等待5秒...")
    time.sleep(5)

    # 测试3: 查询检测结果
    test_check_vulnerability_results()

    # 测试4: 全量检测（如果需要）
    print("\n是否执行全量漏洞检测? 这可能需要几分钟时间。")
    print("全量检测将检测所有公司的所有语言...")
    user_input = input("输入 'yes' 继续，其他键跳过: ")

    if user_input.lower() == 'yes':
        test_detect_all_vulnerabilities()
        print("\n等待5秒...")
        time.sleep(5)
        test_check_vulnerability_results()
    else:
        print("\n跳过全量检测")

    print("\n" + "=" * 60)
    print("测试完成!")
    print("=" * 60)


if __name__ == "__main__":
    main()
